name: Build AppImage (Qt Professional)

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-22.04

    permissions:
      contents: write

    steps:
      # -------------------------------------------------
      # Checkout
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract tag
        id: vars
        run: echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      # -------------------------------------------------
      # Python Setup
      # -------------------------------------------------
      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # -------------------------------------------------
      # System dependencies
      # -------------------------------------------------
      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            pkg-config \
            libdbus-1-dev \
            libglib2.0-dev \
            libgl1 \
            libegl1 \
            libxkbcommon-x11-0 \
            libdbus-1-3 \
            patchelf \
            fuse

      # -------------------------------------------------
      # Python dependencies
      # -------------------------------------------------
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            pyinstaller==6.6.0 \
            setuptools \
            wheel \
            PyQt6 \
            PyQt6-WebEngine \
            python-gettext \
            dbus-python

      # -------------------------------------------------
      # Build with PyInstaller
      # -------------------------------------------------
      - name: Build with PyInstaller
        run: |
          pyinstaller zapzap.spec \
            --distpath dist \
            --workpath build \
            --clean \
            -y

      # -------------------------------------------------
      # Download linuxdeploy + Qt plugin
      # -------------------------------------------------
      - name: Download linuxdeploy
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy-plugin-qt-x86_64.AppImage

      # -------------------------------------------------
      # Prepare AppDir
      # -------------------------------------------------
      - name: Prepare AppDir
        run: |
          mkdir -p AppDir
          cp -r dist/zapzap/* AppDir/

          cp share/icons/com.rtosta.zapzap.svg AppDir/
          cp share/applications/com.rtosta.zapzap.desktop AppDir/

      # -------------------------------------------------
      # Build AppImage
      # -------------------------------------------------
      - name: Build AppImage
        run: |
          OUTPUT="ZapZap-${{ steps.vars.outputs.TAG }}-x86_64.AppImage"

          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --desktop-file AppDir/com.rtosta.zapzap.desktop \
            --icon-file AppDir/com.rtosta.zapzap.svg \
            --plugin qt \
            --output appimage

          FILE=$(ls *.AppImage | head -n 1)
          mv "$FILE" "$OUTPUT"

      # -------------------------------------------------
      # Create GitHub Release
      # -------------------------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ZapZap-${{ steps.vars.outputs.TAG }}-x86_64.AppImage