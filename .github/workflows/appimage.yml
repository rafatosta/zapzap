name: Build AppImage

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-22.04

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract tag
        id: vars
        run: echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            libgl1 \
            libegl1 \
            libxkbcommon-x11-0 \
            libdbus-1-3 \
            patchelf \
            fuse

      - name: Install Python build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            pyinstaller==6.6.0 \
            setuptools \
            wheel

      - name: Build with PyInstaller
        run: |
          pyinstaller zapzap.spec \
            --distpath dist \
            --workpath build \
            --clean \
            -y

      - name: Download AppImageTool
        run: |
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Prepare AppDir
        run: |
          mkdir -p AppDir
          cp -r dist/zapzap/* AppDir/

          cat > AppDir/AppRun <<EOF
          #!/bin/sh
          cd "\$(dirname "\$0")"
          exec ./zapzap
          EOF

          chmod +x AppDir/AppRun

          cp share/icons/com.rtosta.zapzap.svg AppDir/
          cp share/applications/com.rtosta.zapzap.desktop AppDir/zapzap.desktop

      - name: Build AppImage
        run: |
          ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir

      - name: Rename artifact
        run: |
          mv *.AppImage ZapZap-${{ steps.vars.outputs.TAG }}-x86_64.AppImage

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ZapZap-${{ steps.vars.outputs.TAG }}-x86_64.AppImage